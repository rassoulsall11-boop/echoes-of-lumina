<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECHOES OF LUMINA 3D - AETHEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f2ff; --dark: #050505; }
        body { margin: 0; background: var(--dark); color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; touch-action: none; }
        
        /* HUD & UI */
        #hud { position: fixed; top: 20px; left: 20px; z-index: 100; pointer-events: none; }
        .stat-bar { width: 200px; height: 12px; background: rgba(255,255,255,0.1); border: 1px solid var(--neon); border-radius: 6px; overflow: hidden; }
        #energy-fill { width: 100%; height: 100%; background: var(--neon); box-shadow: 0 0 10px var(--neon); transition: width 0.3s; }
        
        #shop-btn { position: fixed; top: 20px; right: 20px; background: gold; border: none; padding: 10px 20px; border-radius: 5px; z-index: 100; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; }
        
        #shop-menu { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; background: rgba(0,0,0,0.9); border: 2px solid var(--neon);
            z-index: 200; padding: 20px; border-radius: 15px; text-align: center;
        }

        /* CONTROLES */
        .controls { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 100; }
        #joy-base { width: 120px; height: 120px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; position: relative; }
        #joy-stick { width: 50px; height: 50px; background: var(--neon); border-radius: 50%; position: absolute; left: 35px; top: 35px; box-shadow: 0 0 15px var(--neon); }
        
        .action-btns { display: flex; flex-direction: column; gap: 15px; }
        .btn { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--neon); background: rgba(0,242,255,0.1); color: var(--neon); font-family: 'Orbitron'; font-size: 10px; font-weight: bold; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.min.js"></script>
</head>
<body>

<div id="hud">
    <div style="font-size: 10px; margin-bottom: 5px;">ONDES CORPORELLES</div>
    <div class="stat-bar"><div id="energy-fill"></div></div>
    <div style="margin-top: 5px; font-size: 12px;">ZONE: AETHEL INFRA-3D</div>
</div>

<button id="shop-btn" onclick="toggleShop()">SHOP</button>

<div id="shop-menu">
    <h2>MAGASIN GEMINI</h2>
    <p>Bracelet Anti-rouille [ACTIF]</p>
    <p>Texture Anti-trace [ACTIF]</p>
    <button onclick="toggleShop()" style="background:var(--neon); border:none; padding:10px 20px; font-family:'Orbitron';">RETOUR</button>
</div>

<div class="controls">
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div class="action-btns">
        <button class="btn" onclick="creerGlace()">GLACE</button>
        <button class="btn" onclick="activerTravers()">TRAVERS</button>
    </div>
</div>

<script>
    // --- CONFIGURATION 3D ---
    let scene, camera, renderer, clock, playerGroup;
    let chunks = new Map();
    const CHUNK_SIZE = 400;
    const VIEW_DIST = 4;
    let energy = 100;
    let vx = 0, vz = 0;
    let isIntangible = false;

    function noise(x, y) {
        return (Math.sin(x * 0.05) + Math.sin(y * 0.05)) * 10;
    }

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050510);
        scene.fog = new THREE.Fog(0x050510, 100, 1000);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lumières
        const light = new THREE.DirectionalLight(0x00f2ff, 1);
        light.position.set(10, 20, 10);
        scene.add(new THREE.AmbientLight(0x404040, 2));
        scene.add(light);

        // Personnage 3D (Groupe)
        playerGroup = new THREE.Group();
        const bodyGeo = new THREE.BoxGeometry(1, 2, 1);
        const bodyMat = new THREE.MeshPhongMaterial({ color: 0xffffff, emissive: 0x00f2ff });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        playerGroup.add(body);
        scene.add(playerGroup);

        clock = new THREE.Clock();
        setupJoystick();
        animate();
    }

    function generateChunk(cx, cz) {
        const key = `${cx}_${cz}`;
        if (chunks.has(key)) return;

        const geo = new THREE.PlaneGeometry(CHUNK_SIZE, CHUNK_SIZE, 20, 20);
        const mat = new THREE.MeshPhongMaterial({ color: 0x111122, wireframe: true });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.rotation.x = -Math.PI / 2;
        mesh.position.set(cx * CHUNK_SIZE, 0, cz * CHUNK_SIZE);

        const pos = geo.attributes.position;
        for(let i=0; i<pos.count; i++) {
            let x = pos.getX(i) + cx * CHUNK_SIZE;
            let y = pos.getZ(i) + cz * CHUNK_SIZE;
            pos.setY(i, noise(x, y));
        }
        scene.add(mesh);
        chunks.set(key, mesh);
    }

    function setupJoystick() {
        const base = document.getElementById('joy-base');
        const stick = document.getElementById('joy-stick');
        base.addEventListener('touchmove', (e) => {
            const t = e.touches[0];
            const r = base.getBoundingClientRect();
            let dx = t.clientX - (r.left + r.width/2);
            let dy = t.clientY - (r.top + r.height/2);
            const d = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
            const angle = Math.atan2(dy, dx);
            
            stick.style.transform = `translate(${Math.cos(angle)*d}px, ${Math.sin(angle)*d}px)`;
            vx = Math.cos(angle) * (d/50) * 0.8;
            vz = Math.sin(angle) * (d/50) * 0.8;
            playerGroup.rotation.y = -angle + Math.PI/2;
        });
        base.addEventListener('touchend', () => {
            stick.style.transform = 'translate(0,0)';
            vx = 0; vz = 0;
        });
    }

    function creerGlace() {
        if(energy < 15) return;
        energy -= 15;
        const iceGeo = new THREE.BoxGeometry(3, 3, 3);
        const iceMat = new THREE.MeshPhongMaterial({ color: 0x00f2ff, transparent: true, opacity: 0.8 });
        const ice = new THREE.Mesh(iceGeo, iceMat);
        ice.position.set(playerGroup.position.x, playerGroup.position.y, playerGroup.position.z);
        scene.add(ice);
    }

    function activerTravers() {
        isIntangible = !isIntangible;
        playerGroup.children[0].material.opacity = isIntangible ? 0.3 : 1;
        playerGroup.children[0].material.transparent = true;
    }

    function toggleShop() {
        const s = document.getElementById('shop-menu');
        s.style.display = s.style.display === 'block' ? 'none' : 'block';
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();

        // Déplacement
        playerGroup.position.x += vx;
        playerGroup.position.z += vz;
        playerGroup.position.y = noise(playerGroup.position.x, playerGroup.position.z) + 1.5;

        // Caméra (3ème personne)
        camera.position.set(playerGroup.position.x, playerGroup.position.y + 5, playerGroup.position.z + 10);
        camera.lookAt(playerGroup.position);

        // Chunks
        const cx = Math.round(playerGroup.position.x / CHUNK_SIZE);
        const cz = Math.round(playerGroup.position.z / CHUNK_SIZE);
        for(let x=-VIEW_DIST; x<=VIEW_DIST; x++) {
            for(let z=-VIEW_DIST; z<=VIEW_DIST; z++) generateChunk(cx+x, cz+z);
        }

        // Énergie
        if(vx !== 0) {
            energy -= 0.05;
            if(energy < 0) energy = 0;
            document.getElementById('energy-fill').style.width = energy + "%";
        }

        renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
</script>
</body>
</html>
